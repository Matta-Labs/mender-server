# Override file for acceptance tests
# NOTE: paths are relative to $GIT_ROOT/backend/tests
services:
  acceptance-tester:
    volumes:
      - ../services/workflows/tests:/testing
      - ../services/workflows/docs:/docs
    depends_on:
      - mmock

  mmock:
    image: jordimartin/mmock:v2.7.6
    command: ["-server-ip", "0.0.0.0", "-console-ip", "0.0.0.0", "-server-port", "8080"]
    ports:
      - 8082:8082
    volumes:
      - "../services/workflows/tests/mmock:/config"
    networks:
      default:
        aliases:
          - mender-inventory
          - mender-deployments
          - mender-device-auth
          - mender-deviceauth
          - mender-deviceconnect
          - mender-deviceconfig
          - mender-reporting
          - mender-iot-manager
          - inventory
          - deployments
          - device-auth
          - deviceconnect
          - deviceconfig
          - reporting
          - iot-manager
          - mmock

  workflows-worker:
    image: workflows:test
    build:
      args:
        - BIN_FILE=backend/tests/bin/workflows.test
    user: ${UID:-0}:${GID:-0}
    volumes:
      - ".:/testing"
      - "../worker/workflows:/etc/workflows/definitions"
      - ./cover:/cover
    working_dir: /testing
    environment:
      HAVE_DEVICECONNECT: 1
      HAVE_DEVICECONFIG: 1
      AUDITLOGS_ADDR: mender-auditlogs:8080
      DEPLOYMENTS_ADDR: mender-deployments:8080
      DEVICEAUTH_ADDR: mender-deviceauth:8080
      DEVICECONFIG_ADDR: mender-deviceconfig:8080
      DEVICECONNECT_ADDR: mender-deviceconnect:8080
      INVENTORY_ADDR: mender-inventory:8080
      IOT_MANAGER_ADDR: mender-iot-manager:8080
      TENANTADM_ADDR: mender-tenantadm:8080
      USERADM_ADDR: mender-useradm:8080
      WORKFLOWS_SERVER_ADDR: workflows:8080
      GOCOVERDIR: /cover
    restart: always
    depends_on:
      - mongo

  workflows:
    image: workflows:test
    build:
      args:
        - BIN_FILE=backend/tests/bin/workflows.test
    ports:
      - "8080:8080"
    environment:
      GOCOVERDIR: /cover
    user: ${UID:-0}:${GID:-0}
    volumes:
      - ".:/testing"
      - ./cover:/cover
    working_dir: /testing
    networks:
      default:
        aliases:
          - mender-workflows-server
          - workflows-server
    restart: always
    depends_on:
      - mongo
      - nats
